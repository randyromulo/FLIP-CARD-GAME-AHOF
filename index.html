<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>AHOF â€” Flip Card Ultimate</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow+Condensed:ital,wght@0,400;0,600;0,700;0,800;1,600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#08080d;--panel:#0f0f1a;--gold:#f6ca3a;--gold2:#b8900a;
  --red:#e8293a;--cyan:#00d4ff;--green:#00e87a;--purple:#9b40ff;
  --border:#1c1c30;--glow:rgba(246,202,58,.3);
  --card-back:linear-gradient(150deg,#0d0d28,#131340,#09091e);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);font-family:'Barlow Condensed',sans-serif;color:#fff;display:flex;flex-direction:column;}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:998;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.07) 2px,rgba(0,0,0,.07) 4px);}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse 90% 60% at 50% 0%,rgba(155,64,255,.1) 0%,transparent 55%);}
#app{position:relative;z-index:1;display:flex;flex-direction:column;height:100%;}

/* SCREENS */
.screen{flex:1;display:flex;flex-direction:column;overflow-y:auto;}
.screen.off{display:none!important;}

/* â•â• SETUP â•â• */
#setupScreen{align-items:center;}
.shero{width:100%;padding:22px 20px 16px;text-align:center;
  background:linear-gradient(180deg,rgba(155,64,255,.14) 0%,transparent 100%);border-bottom:1px solid var(--border);flex-shrink:0;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:clamp(3.5rem,12vw,6rem);letter-spacing:8px;line-height:.9;
  background:linear-gradient(135deg,#c8a200,var(--gold) 35%,#fff 55%,var(--gold) 75%,#c8a200);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 30px rgba(246,202,58,.5));}
.logo-t{font-family:'Bebas Neue',sans-serif;font-size:.68rem;letter-spacing:9px;color:#1e1e38;margin-top:2px;}
.logo-d{font-size:.76rem;letter-spacing:3px;color:var(--purple);margin-top:5px;font-style:italic;}
.sbody{width:100%;max-width:500px;margin:0 auto;padding:16px 16px 28px;display:flex;flex-direction:column;gap:14px;}
.sec{font-family:'Bebas Neue',sans-serif;font-size:.92rem;letter-spacing:4px;color:var(--gold);border-bottom:1px solid var(--border);padding-bottom:5px;}
.mgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;}
.mslot{display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;}
.mav{width:76px;height:76px;border-radius:13px;border:2px solid var(--border);background:#0c0c1e;
  display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;transition:all .22s;}
.mav:hover{border-color:var(--gold);box-shadow:0 0 16px var(--glow);transform:scale(1.05);}
.mav img{width:100%;height:100%;object-fit:cover;}
.mav.filled{border-color:var(--gold);}
.mav.filled::after{content:'âœ“';position:absolute;bottom:2px;right:4px;font-size:.58rem;color:var(--green);font-weight:900;}
.mname{background:transparent;border:none;border-bottom:1px solid #1a1a2c;color:#555;
  font-family:'Barlow Condensed',sans-serif;font-size:.66rem;letter-spacing:1px;
  width:83px;text-align:center;outline:none;padding:2px;text-transform:uppercase;transition:border-color .2s;}
.mname:focus{border-bottom-color:var(--gold);color:#fff;}
.drow{display:flex;gap:7px;}
.dp{flex:1;padding:9px 4px;border-radius:9px;border:2px solid var(--border);background:transparent;
  color:#3a3a5a;font-family:'Bebas Neue',sans-serif;font-size:.95rem;letter-spacing:2px;cursor:pointer;transition:all .2s;text-align:center;}
.dp span{display:block;font-size:.58rem;letter-spacing:1px;color:#1e1e35;margin-top:1px;}
.dp.on{border-color:var(--purple);color:var(--purple);background:rgba(155,64,255,.1);}
.btn-go{padding:14px;border-radius:13px;border:none;
  background:linear-gradient(135deg,var(--gold2),var(--gold),#fff8d0,var(--gold),var(--gold2));
  color:#000;font-family:'Bebas Neue',sans-serif;font-size:1.35rem;letter-spacing:5px;cursor:pointer;transition:all .25s;
  box-shadow:0 4px 22px rgba(246,202,58,.38);}
.btn-go:hover{transform:translateY(-3px);box-shadow:0 10px 32px rgba(246,202,58,.58);}
.note{font-size:.68rem;color:#18182a;text-align:center;line-height:1.6;}

/* LEADERBOARD */
.lbbox{background:var(--panel);border:1px solid var(--border);border-radius:13px;padding:12px;display:flex;flex-direction:column;gap:7px;}
.lbrow{display:flex;align-items:center;gap:8px;padding:5px 9px;background:rgba(255,255,255,.03);border-radius:7px;}
.lbr{font-family:'Bebas Neue',sans-serif;font-size:1rem;width:22px;}
.lbr.g{color:var(--gold);}  .lbr.s{color:#aaa;}  .lbr.b{color:#cd7f32;}
.lbn{flex:1;font-size:.88rem;letter-spacing:1px;color:#bbb;}
.lbs{font-size:.72rem;}
.lbsc{font-family:'Bebas Neue',sans-serif;font-size:.95rem;color:var(--cyan);}
.lb-empty{font-size:.78rem;color:#181828;text-align:center;padding:8px;}

/* â•â• GAME â•â• */
#gameScreen{display:none;flex-direction:column;overflow:hidden;}
.hud{background:var(--panel);border-bottom:1px solid var(--border);
  padding:6px 9px;display:flex;align-items:center;justify-content:space-between;gap:5px;flex-shrink:0;}
.hc{display:flex;flex-direction:column;align-items:center;background:rgba(255,255,255,.03);
  border:1px solid var(--border);border-radius:8px;padding:3px 7px;min-width:44px;}
.hc .v{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;line-height:1;color:var(--gold);}
.hc .l{font-size:.46rem;letter-spacing:2px;color:#252538;}
.hlvl{display:flex;flex-direction:column;align-items:center;
  background:rgba(155,64,255,.1);border:1px solid rgba(155,64,255,.3);border-radius:8px;padding:3px 8px;min-width:50px;}
.hlvl .lv{font-family:'Bebas Neue',sans-serif;font-size:1.35rem;line-height:1;
  background:linear-gradient(135deg,var(--purple),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.hlvl .ll{font-size:.46rem;letter-spacing:2px;color:var(--purple);}
.timer-wrap{display:flex;flex-direction:column;align-items:center;flex:1;min-width:70px;}
.tdisp{font-family:'Bebas Neue',sans-serif;font-size:1.45rem;line-height:1;color:var(--green);transition:color .3s;}
.tdisp.warn{color:var(--gold);animation:tpulse .5s ease-in-out infinite;}
.tdisp.danger{color:var(--red);animation:tpulse .22s ease-in-out infinite;}
@keyframes tpulse{50%{opacity:.3;}}
.ttrack{width:100%;max-width:130px;height:4px;background:rgba(255,255,255,.07);border-radius:2px;overflow:hidden;margin-top:2px;}
.tfill{height:100%;border-radius:2px;transition:width .4s linear,background .3s;}
.spd-w{display:flex;flex-direction:column;align-items:center;min-width:48px;}
.spd-t{width:46px;height:4px;background:rgba(255,255,255,.07);border-radius:2px;overflow:hidden;}
.spd-f{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--green),var(--gold),var(--red));transition:width .5s;}
.spd-l{font-size:.46rem;letter-spacing:2px;color:#252538;margin-top:2px;font-family:'Bebas Neue',sans-serif;}
.mbtn{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:7px;
  padding:3px 6px;cursor:pointer;font-size:.75rem;color:#2a2a44;transition:all .2s;flex-shrink:0;}
.mbtn.on{border-color:var(--purple);color:var(--purple);}

/* XP bar */
.xpstrip{height:4px;background:rgba(255,255,255,.04);flex-shrink:0;}
.xpfill{height:100%;background:linear-gradient(90deg,var(--purple),var(--cyan),var(--gold));transition:width .4s;}

/* POWER-UP TRAY */
.putray{display:flex;align-items:center;gap:5px;padding:5px 9px;
  background:rgba(0,0,0,.3);border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;}
.putray::-webkit-scrollbar{display:none;}
.pu-lbl{font-size:.58rem;letter-spacing:2px;color:#1e1e35;font-family:'Bebas Neue',sans-serif;white-space:nowrap;flex-shrink:0;}
.pub{padding:4px 9px;border-radius:7px;border:1px solid;font-family:'Bebas Neue',sans-serif;
  font-size:.78rem;letter-spacing:1px;cursor:pointer;transition:all .2s;position:relative;
  display:flex;align-items:center;gap:3px;flex-shrink:0;white-space:nowrap;}
.pub:disabled{opacity:.25;cursor:not-allowed;}
.pub .pc{position:absolute;top:-5px;right:-5px;background:var(--red);color:#fff;border-radius:50%;
  width:14px;height:14px;font-size:.5rem;display:flex;align-items:center;justify-content:center;}
.puf{color:var(--cyan);border-color:rgba(0,212,255,.3);background:rgba(0,212,255,.06);}
.puf:not(:disabled):hover{background:rgba(0,212,255,.15);}
.pur{color:var(--gold);border-color:rgba(246,202,58,.3);background:rgba(246,202,58,.06);}
.pur:not(:disabled):hover{background:rgba(246,202,58,.15);}
.pub2{color:var(--red);border-color:rgba(232,41,58,.3);background:rgba(232,41,58,.06);}
.pub2:not(:disabled):hover{background:rgba(232,41,58,.15);}
.puw{color:#ff88ff;border-color:rgba(255,136,255,.3);background:rgba(255,136,255,.06);}
.puw:not(:disabled):hover{background:rgba(255,136,255,.15);}

/* GRID */
.gwrap{flex:1;overflow-y:auto;padding:9px;display:flex;align-items:flex-start;justify-content:center;}
.gwrap::-webkit-scrollbar{width:3px;}
.gwrap::-webkit-scrollbar-thumb{background:var(--border);}
.cgrid{display:grid;gap:7px;width:100%;}

/* CARD */
.card{perspective:900px;cursor:pointer;border-radius:11px;}
.ci{width:100%;height:100%;position:relative;transform-style:preserve-3d;
  transition:transform .38s cubic-bezier(.23,1,.32,1);border-radius:11px;}
.card.flipped .ci,.card.matched .ci{transform:rotateY(180deg);}
.card.wrong .ci{animation:wsh .3s ease;}
@keyframes wsh{0%,100%{transform:rotateY(180deg);}25%{transform:rotateY(180deg) translateX(-8px);}75%{transform:rotateY(180deg) translateX(8px);}}
.card.matched .cb{border-color:var(--green);box-shadow:0 0 18px rgba(0,232,122,.5);}
.card.matched .cb::after{content:'âœ“';position:absolute;top:4px;right:5px;font-size:.85rem;color:var(--green);z-index:3;font-weight:900;}
.card.mystery .cf{border-color:rgba(255,136,255,.6)!important;box-shadow:0 0 14px rgba(255,136,255,.4)!important;}
.card.mystery-matched .cb{border-color:#ff88ff!important;box-shadow:0 0 22px rgba(255,136,255,.6)!important;}
.cf,.cb{position:absolute;inset:0;border-radius:11px;overflow:hidden;backface-visibility:hidden;-webkit-backface-visibility:hidden;border:2px solid var(--border);}
.cf{background:var(--card-back);display:flex;align-items:center;justify-content:center;}
.cpat{width:60%;height:60%;opacity:.1;border-radius:6px;
  background:repeating-linear-gradient(45deg,rgba(155,64,255,.4) 0,rgba(155,64,255,.4) 1px,transparent 1px,transparent 8px),
             repeating-linear-gradient(-45deg,rgba(0,212,255,.3) 0,rgba(0,212,255,.3) 1px,transparent 1px,transparent 8px);}
.clbl{position:absolute;font-family:'Bebas Neue',sans-serif;font-size:.75rem;letter-spacing:3px;color:rgba(155,64,255,.18);}
.cb{transform:rotateY(180deg);background:#0e0e20;display:flex;flex-direction:column;overflow:hidden;}
.cb img{width:100%;flex:1;object-fit:cover;object-position:center top;}
.cname{text-align:center;font-family:'Bebas Neue',sans-serif;font-size:.66rem;letter-spacing:2px;
  color:rgba(255,255,255,.8);background:rgba(0,0,0,.6);padding:3px 2px;flex-shrink:0;}

/* COMBO BADGE */
.combo-badge{position:fixed;top:17%;right:12px;z-index:90;font-family:'Bebas Neue',sans-serif;
  font-size:1.7rem;letter-spacing:2px;text-align:right;pointer-events:none;transition:all .2s;}
.combo-badge.off{opacity:0;}

/* OVERLAYS */
.ov{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.93);backdrop-filter:blur(14px);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:15px;padding:20px;}
.ov.off{display:none;}
.ovbig{font-family:'Bebas Neue',sans-serif;font-size:clamp(2.2rem,8vw,5rem);text-align:center;letter-spacing:5px;
  animation:ovpop .55s cubic-bezier(.175,.885,.32,1.275);}
@keyframes ovpop{0%{transform:scale(.2) rotate(-8deg);opacity:0;}70%{transform:scale(1.06);}100%{transform:scale(1);opacity:1;}}
.ov-gold{color:var(--gold);filter:drop-shadow(0 0 28px var(--gold));}
.ov-red{color:var(--red);filter:drop-shadow(0 0 28px var(--red));}
.ovbody{font-size:.92rem;color:#484868;letter-spacing:1px;text-align:center;line-height:2.2;max-width:320px;}
.ovbody b{color:var(--gold);font-size:1.1rem;}
.stars-row{display:flex;gap:7px;justify-content:center;}
.st{font-size:2rem;opacity:.2;transition:all .4s;}
.st.lit{opacity:1;animation:stpop .4s cubic-bezier(.175,.885,.32,1.275) forwards;}
@keyframes stpop{0%{transform:scale(.2);}70%{transform:scale(1.3);}100%{transform:scale(1);}}
.ovbtns{display:flex;gap:9px;flex-wrap:wrap;justify-content:center;}
.ob{padding:11px 20px;border-radius:10px;border:none;cursor:pointer;font-family:'Bebas Neue',sans-serif;font-size:.9rem;letter-spacing:3px;transition:all .2s;}
.ob:hover{transform:translateY(-2px);}
.obg{background:linear-gradient(135deg,var(--gold2),var(--gold));color:#000;box-shadow:0 4px 14px rgba(246,202,58,.3);}
.obr{background:linear-gradient(135deg,#800,var(--red));color:#fff;}
.obo{background:transparent;border:2px solid #181828;color:#2a2a44;}

/* LVL UP */
#lvlov{position:fixed;inset:0;z-index:150;pointer-events:none;display:flex;align-items:center;justify-content:center;}
#lvlov.off{display:none;}
.lvlburst{font-family:'Bebas Neue',sans-serif;font-size:clamp(3rem,12vw,7rem);letter-spacing:5px;text-align:center;
  animation:lvlanim 2s cubic-bezier(.175,.885,.32,1.275) forwards;}
@keyframes lvlanim{0%{transform:scale(.2) rotate(-15deg);opacity:0;}25%{transform:scale(1.2) rotate(3deg);opacity:1;}55%{transform:scale(1) rotate(0);opacity:1;}85%{transform:scale(1.05);opacity:1;}100%{transform:scale(1) translateY(-40px);opacity:0;}}

/* POPUP */
.popup{position:fixed;top:36%;left:50%;transform:translateX(-50%);
  font-family:'Bebas Neue',sans-serif;font-size:clamp(1.4rem,4.2vw,2.5rem);
  letter-spacing:4px;text-align:center;pointer-events:none;z-index:130;white-space:nowrap;
  animation:pfade 1.3s ease-out forwards;}
@keyframes pfade{0%{opacity:0;transform:translateX(-50%) scale(.5);}20%{opacity:1;transform:translateX(-50%) scale(1.04);}75%{opacity:1;}100%{opacity:0;transform:translateX(-50%) translateY(-36px);}}

/* PU MSG */
.pumsg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  font-family:'Bebas Neue',sans-serif;font-size:clamp(1.8rem,5.5vw,3.5rem);letter-spacing:4px;
  text-align:center;pointer-events:none;z-index:125;
  animation:pfade2 1.5s ease-out forwards;}
@keyframes pfade2{0%{opacity:0;transform:translate(-50%,-50%) scale(.5);}20%{opacity:1;transform:translate(-50%,-50%) scale(1.05);}75%{opacity:1;}100%{opacity:0;transform:translate(-50%,-55%);}}

/* EFFECTS */
#sflash{position:fixed;inset:0;pointer-events:none;z-index:105;transition:background .08s;}
#freezeov{position:fixed;inset:0;pointer-events:none;z-index:100;background:rgba(0,212,255,.06);display:none;
  animation:fpulse 1s ease-in-out infinite;border:2px solid rgba(0,212,255,.18);}
@keyframes fpulse{50%{background:rgba(0,212,255,.13);}}
@keyframes sshake{0%,100%{transform:translateX(0);}20%{transform:translateX(-6px);}40%{transform:translateX(6px);}60%{transform:translateX(-4px);}80%{transform:translateX(4px);}}
#app.shaking{animation:sshake .32s ease;}
.cp{position:fixed;pointer-events:none;z-index:140;animation:cpfall linear forwards;}
@keyframes cpfall{0%{transform:translateY(-10px) rotate(0);opacity:1;}100%{transform:translateY(105vh) rotate(800deg);opacity:0;}}
body.intense{animation:ibg .9s ease-in-out infinite;}
@keyframes ibg{50%{background:#0e080d;}}
body.critical{animation:cbg .35s ease-in-out infinite;}
@keyframes cbg{50%{background:#160406;}}
</style>
</head>
<body>
<div id="app">

<!-- â•â• SETUP â•â• -->
<div id="setupScreen" class="screen">
  <div class="shero">
    <div class="logo">AHOF</div>
    <div class="logo-t">FLIP CARD ULTIMATE EDITION</div>
    <div class="logo-d">âœ¦ Time Bomb Â· Combos Â· Power-Ups Â· Stars Â· Leaderboard âœ¦</div>
  </div>
  <div class="sbody">
    <div class="sec">ğŸ‘¤ 9 MEMBERS â€” UPLOAD THE PICTURE</div>
    <div class="mgrid" id="mgrid"></div>
    <div class="note">I-tap ang slot para mag-upload ng larawan â€¢ Palitan ang pangalan</div>
    <div class="sec">ğŸ® DIFFICULTY</div>
    <div class="drow">
      <button class="dp on" id="d-easy"   onclick="setDiff('easy')">EASY<span>6 pairs Â· 60s</span></button>
      <button class="dp"    id="d-medium" onclick="setDiff('medium')">MEDIUM<span>9 pairs Â· 50s</span></button>
      <button class="dp"    id="d-hard"   onclick="setDiff('hard')">HARD<span>9 pairs Â· 35s</span></button>
    </div>
    <button class="btn-go" onclick="startGame()">â–¶ MAGLARO NA â—€</button>
    <div class="sec">ğŸ† LEADERBOARD â€” TOP SCORES</div>
    <div class="lbbox" id="lbbox"></div>
    <div class="note">Endless Mode Â· Pabilis ng pabilis Â· Mystery cards = power-ups Â· Level up = bonus!</div>
  </div>
</div>

<!-- â•â• GAME â•â• -->
<div id="gameScreen" class="screen off">
  <div class="hud">
    <div class="hlvl"><div class="lv" id="hLv">1</div><div class="ll">LEVEL</div></div>
    <div class="hc"><div class="v" id="hM">0</div><div class="l">MATCH</div></div>
    <div class="timer-wrap">
      <div class="tdisp" id="tdisp">60</div>
      <div class="ttrack"><div class="tfill" id="tfill" style="width:100%;background:var(--green)"></div></div>
    </div>
    <div class="hc"><div class="v" id="hMv">0</div><div class="l">MOVES</div></div>
    <div class="spd-w">
      <div class="spd-t"><div class="spd-f" id="spdBar" style="width:2%"></div></div>
      <div class="spd-l" id="spdLbl">Ã—1.0</div>
    </div>
    <button class="mbtn on" id="mbtn" onclick="toggleMusic()">â™ª</button>
  </div>
  <div class="xpstrip"><div class="xpfill" id="xpfill" style="width:0%"></div></div>
  <div class="putray">
    <div class="pu-lbl">PWR-UPS:</div>
    <button class="pub puf" id="puF" onclick="usePU('freeze')" disabled>â„ï¸ FREEZE<div class="pc" id="pcF">0</div></button>
    <button class="pub pur" id="puR" onclick="usePU('reveal')" disabled>ğŸ‘ PEEK<div class="pc" id="pcR">0</div></button>
    <button class="pub pub2" id="puB" onclick="usePU('bomb')" disabled>ğŸ’£ SOLVE<div class="pc" id="pcB">0</div></button>
    <button class="pub puw" id="puW" onclick="usePU('wild')" disabled>âš¡ +TIME<div class="pc" id="pcW">0</div></button>
  </div>
  <div class="gwrap"><div class="cgrid" id="cgrid"></div></div>
</div>

<!-- WIN -->
<div class="ov off" id="winOv">
  <div class="ovbig ov-gold">ğŸ† BOARD CLEAR!</div>
  <div class="stars-row" id="winStars"></div>
  <div class="ovbody" id="winBody"></div>
  <div class="ovbtns">
    <button class="ob obg" onclick="nextBoard()">â–¶ NEXT BOARD</button>
    <button class="ob obo" onclick="goSetup()">ğŸ“‹ MENU</button>
  </div>
</div>

<!-- GAME OVER -->
<div class="ov off" id="goOv">
  <div class="ovbig ov-red">ğŸ’€ TIME'S UP!</div>
  <div class="stars-row" id="goStars"></div>
  <div class="ovbody" id="goBody"></div>
  <div class="ovbtns">
    <button class="ob obr" onclick="restartGame()">ğŸ”„ ULIT</button>
    <button class="ob obg" onclick="goSetup()">ğŸ“‹ MENU</button>
  </div>
</div>

<!-- LVL UP -->
<div id="lvlov" class="off">
  <div class="lvlburst" id="lvltxt" style="color:var(--gold)"></div>
</div>

<div class="combo-badge off" id="comboBadge"></div>
<div id="sflash"></div>
<div id="freezeov"></div>
</div>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ğŸµ  K-POP SYNTH MUSIC ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let AC=null,musicOn=true;
let bTmr=null,mTmr=null,bsTmr=null;
let bStep=0,mStep=0,bsStep=0;
let intensity=0,tMult=1.0;

function ctx(){
  if(!AC) AC=new(window.AudioContext||window.webkitAudioContext)();
  if(AC.state==='suspended') AC.resume();
  return AC;
}
function osc(f,t,d,v,dl=0,fe=null){
  try{
    const c=ctx(),at=c.currentTime+dl,o=c.createOscillator(),g=c.createGain();
    o.type=t;o.frequency.setValueAtTime(f,at);
    if(fe) o.frequency.exponentialRampToValueAtTime(fe,at+d*.8);
    g.gain.setValueAtTime(v,at);g.gain.exponentialRampToValueAtTime(.0001,at+d);
    o.connect(g);g.connect(c.destination);o.start(at);o.stop(at+d+.02);
  }catch(e){}
}
function nz(d,v,dl=0,lp=8000){
  try{
    const c=ctx(),at=c.currentTime+dl,len=Math.ceil(c.sampleRate*d);
    const buf=c.createBuffer(1,len,c.sampleRate),dat=buf.getChannelData(0);
    for(let i=0;i<len;i++) dat[i]=Math.random()*2-1;
    const src=c.createBufferSource(),g=c.createGain(),f=c.createBiquadFilter();
    src.buffer=buf;f.type='lowpass';f.frequency.value=lp;
    g.gain.setValueAtTime(v,at);g.gain.exponentialRampToValueAtTime(.0001,at+d);
    src.connect(f);f.connect(g);g.connect(c.destination);src.start(at);src.stop(at+d+.02);
  }catch(e){}
}
function kick(v=.32){
  try{
    const c=ctx(),at=c.currentTime,o=c.createOscillator(),g=c.createGain();
    o.frequency.setValueAtTime(160,at);o.frequency.exponentialRampToValueAtTime(35,at+.18);
    g.gain.setValueAtTime(v,at);g.gain.exponentialRampToValueAtTime(.0001,at+.22);
    o.connect(g);g.connect(c.destination);o.start(at);o.stop(at+.26);
  }catch(e){}
}
function snare(v=.14){nz(.1,v,0,5000);osc(200,'square',.06,v*.5);}
function hat(v=.05){nz(.03,v,0,12000);}
function clap(v=.1){for(let i=0;i<3;i++)nz(.04,v*.8,i*.011,7000);}
function bass(n,d=.18,v=.2){osc(n,'sawtooth',d,v*.7);osc(n*.5,'sine',d,v);}
function lead(f,d=.12,v=.14){osc(f,'square',d,v*.6);osc(f*2,'triangle',d,v*.35);}
function stab(r,v=.07){[1,1.26,1.498,2].forEach((x,i)=>osc(r*x,'sawtooth',.14,v,i*.01));}

const N={C3:130.8,D3:146.8,E3:164.8,F3:174.6,G3:196,A3:220,B3:246.9,
  C4:261.6,D4:293.7,E4:329.6,F4:349.2,G4:392,A4:440,B4:493.9,
  C5:523.3,D5:587.3,E5:659.3,F5:698.5,G5:784,A5:880};

// Melody â€” A-minor K-pop hook
const MC=[{n:N.A4,d:.12},{n:null,d:.06},{n:N.C5,d:.12},{n:N.E5,d:.18},
  {n:N.D5,d:.12},{n:N.C5,d:.12},{n:null,d:.06},{n:N.A4,d:.2},
  {n:N.G4,d:.12},{n:null,d:.06},{n:N.A4,d:.12},{n:N.C5,d:.12},
  {n:N.B4,d:.12},{n:N.A4,d:.22},{n:null,d:.1},{n:N.E4,d:.1},
  {n:N.G4,d:.1},{n:N.A4,d:.12},{n:N.C5,d:.18},{n:N.D5,d:.1},
  {n:N.E5,d:.22},{n:null,d:.1},{n:N.C5,d:.1},{n:N.A4,d:.1},
  {n:N.G4,d:.1},{n:null,d:.06},{n:N.F4,d:.1},{n:N.G4,d:.18},{n:N.A4,d:.22}];
const MI=[{n:N.A4,d:.08},{n:N.C5,d:.08},{n:N.E5,d:.08},{n:N.G5,d:.1},
  {n:N.E5,d:.08},{n:N.C5,d:.08},{n:N.A4,d:.08},{n:null,d:.05},
  {n:N.F4,d:.08},{n:N.A4,d:.08},{n:N.C5,d:.08},{n:N.E5,d:.1},
  {n:N.D5,d:.08},{n:N.B4,d:.08},{n:N.G4,d:.08},{n:null,d:.05},
  {n:N.A4,d:.08},{n:N.G4,d:.05},{n:N.E4,d:.08},{n:N.A4,d:.1},
  {n:N.C5,d:.08},{n:N.D5,d:.08},{n:N.E5,d:.08},{n:N.C5,d:.08},
  {n:N.A4,d:.05},{n:null,d:.05},{n:N.G4,d:.08},{n:N.A4,d:.08},
  {n:N.C5,d:.08},{n:N.E5,d:.16},{n:null,d:.08}];
const BC=[{n:N.A3,d:.34},{n:null,d:.1},{n:N.A3,d:.22},{n:null,d:.1},
  {n:N.G3,d:.34},{n:null,d:.1},{n:N.F3,d:.34},{n:null,d:.1},
  {n:N.C3,d:.34},{n:N.E3,d:.22},{n:null,d:.1},{n:N.A3,d:.34}];
const BI=[{n:N.A3,d:.16},{n:N.A3,d:.1},{n:null,d:.05},{n:N.C4,d:.16},
  {n:null,d:.05},{n:N.A3,d:.1},{n:N.G3,d:.16},{n:null,d:.1},
  {n:N.F3,d:.16},{n:N.F3,d:.1},{n:null,d:.05},{n:N.G3,d:.16},
  {n:null,d:.05},{n:N.A3,d:.22},{n:null,d:.1}];
const DC=[{k:1,s:0,h:1,c:0},{k:0,s:0,h:0},{k:0,s:0,h:1},{k:0,s:0,h:0},
  {k:0,s:1,h:1,c:1},{k:0,s:0,h:0},{k:0,s:0,h:1},{k:0,s:0,h:0},
  {k:1,s:0,h:1},{k:0,s:0,h:0},{k:1,s:0,h:1},{k:0,s:0,h:0},
  {k:0,s:1,h:1,c:1},{k:0,s:0,h:0},{k:0,s:0,h:1},{k:0,s:0,h:0}];
const DI=[{k:1,s:0,h:1},{k:0,s:0,h:1},{k:0,s:1,h:0,c:1},{k:0,s:0,h:1},
  {k:1,s:1,h:1},{k:1,s:0,h:1},{k:0,s:0,h:1},{k:0,s:0,h:1},
  {k:1,s:0,h:1},{k:0,s:0,h:1},{k:1,s:1,h:1,c:1},{k:0,s:0,h:1},
  {k:1,s:1,h:1},{k:1,s:0,h:1},{k:0,s:0,h:1},{k:0,s:1,h:1,c:1}];
const DCR=[{k:1,s:1,h:1,c:1},{k:1,s:0,h:1},{k:1,s:1,h:1},{k:1,s:0,h:1,c:1},
  {k:1,s:1,h:1},{k:1,s:0,h:1,c:1},{k:1,s:1,h:1},{k:1,s:1,h:1},
  {k:1,s:1,h:1,c:1},{k:1,s:0,h:1},{k:1,s:1,h:1},{k:1,s:0,h:1,c:1},
  {k:1,s:1,h:1,c:1},{k:1,s:1,h:1},{k:1,s:1,h:1,c:1},{k:1,s:1,h:1,c:1}];

function getDr(){return intensity===2?DCR:intensity===1?DI:DC;}
function getMel(){return intensity>=1?MI:MC;}
function getBs(){return intensity>=1?BI:BC;}

function drumLoop(){
  if(!musicOn||!G.rn){bTmr=null;return;}
  const s=getDr()[bStep%getDr().length];bStep++;
  const v=intensity===2?1.4:intensity===1?1.15:1;
  if(s.k)kick(.3*v);if(s.s)snare(.14*v);if(s.h)hat(.05*v);if(s.c)clap(.09*v);
  bTmr=setTimeout(drumLoop,Math.max(45,105/tMult));
}
function melLoop(){
  if(!musicOn||!G.rn){mTmr=null;return;}
  const p=getMel(),s=p[mStep%p.length];mStep++;
  if(s.n)lead(s.n,.12+s.d*.4,.12*(intensity>=1?1.15:1));
  mTmr=setTimeout(melLoop,Math.max(35,(s.d*1000)/tMult));
}
function bassLoop(){
  if(!musicOn||!G.rn){bsTmr=null;return;}
  const p=getBs(),s=p[bsStep%p.length];bsStep++;
  if(s.n){bass(s.n,s.d*.9,.2);if(bsStep%4===0)stab(s.n*.5,.06);}
  bsTmr=setTimeout(bassLoop,Math.max(40,(s.d*1000)/tMult));
}
function startMusic(){
  if(!musicOn)return;
  stopMusic();bStep=0;mStep=0;bsStep=0;drumLoop();melLoop();bassLoop();
}
function stopMusic(){[bTmr,mTmr,bsTmr].forEach(t=>{if(t)clearTimeout(t);});bTmr=mTmr=bsTmr=null;}
function toggleMusic(){
  musicOn=!musicOn;const b=document.getElementById('mbtn');
  b.textContent=musicOn?'â™ª':'â™«';b.classList.toggle('on',musicOn);
  if(musicOn&&G.rn)startMusic();else stopMusic();
}

// â”€â”€ SFX â”€â”€
function sfxFlip(){osc(300+Math.random()*80,'sine',.07,.12);nz(.04,.04);}
function sfxFlipBack(){osc(200,'sine',.06,.07);}
function sfxMatch(){[523,659,784,1047,1319].forEach((f,i)=>{osc(f,'triangle',.18,.22,i*.06);osc(f*1.5,'sine',.1,.08,i*.06);});nz(.06,.08,.04);}
function sfxCombo(n){const f=440*(1+n*.15);osc(f,'square',.12,.2);osc(f*2,'triangle',.1,.12,.04);if(n>=3){nz(.08,.12,.02);kick(.4);}}
function sfxWrong(){osc(220,'sawtooth',.16,.3);osc(180,'sawtooth',.14,.22,.08);nz(.18,.15);}
function sfxLevelUp(){[392,494,587,784,988,1175,1568].forEach((f,i)=>{osc(f,'triangle',.22,.32,i*.055);osc(f*2,'sine',.1,.1,i*.055);});nz(.3,.2,.1);kick(.5);}
function sfxWin(){const m=[523,523,523,784,659,523,784,659,784,1047],d=[.12,.12,.12,.32,.12,.12,.18,.08,.08,.6];let t=0;m.forEach((f,i)=>{osc(f,'triangle',d[i],.38,t);osc(f*1.5,'sine',d[i]*.6,.14,t);t+=d[i]+.025;});[0,.15,.3,.45].forEach(()=>kick(.4));}
function sfxGameOver(){osc(300,'sawtooth',.8,.3,0,80);nz(.4,.2,.1);}
function sfxSpeedUp(){osc(500,'sawtooth',.3,.2,0,1400);nz(.12,.1,.08);}
function sfxPU(t){
  if(t==='freeze'){osc(800,'sine',.4,.2,0,200);nz(.15,.08,.1,3000);}
  else if(t==='reveal'){[523,659,784].forEach((f,i)=>osc(f,'triangle',.12,.2,i*.05));}
  else if(t==='bomb'){kick(.5);osc(300,'sawtooth',.2,.25,0,600);nz(.2,.18,.05);}
  else{osc(660,'square',.15,.2);osc(880,'triangle',.1,.15,.08);}
}
function sfxTick(){osc(880,'sine',.06,.18);}
function sfxTickDanger(){osc(1100,'square',.04,.25);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEF_MEM=[
  {name:'JL',img:null},{name:'STEVEN',img:null},{name:'DAISUKE',img:null},
  {name:'JUWON',img:null},{name:'JEONGWOO',img:null},{name:'WOONGKI',img:null},
  {name:'SHUAIBO',img:null},{name:'CHIH-EN',img:null},{name:'PARK HAN',img:null},
];
let members=DEF_MEM.map(m=>({...m}));
let difficulty='easy';
const DIFF={easy:{pairs:6,time:60},medium:{pairs:9,time:50},hard:{pairs:9,time:35}};
function xpFor(l){return 70+l*50;}
let PU={freeze:0,reveal:0,bomb:0,wild:0};
let G={
  cards:[],flipped:[],matched:0,totalPairs:0,
  moves:0,elapsed:0,startTime:0,
  tick:null,revealTime:1.4,timeouts:[],
  locked:false,rn:false,speedMult:1.0,
  level:1,xp:0,xpNeeded:100,
  totalMatches:0,totalBoards:0,totalMoves:0,totalScore:0,
  combo:0,maxCombo:0,
  boardTime:60,timeLeft:60,frozen:false,
  boardStars:0,playerName:'',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LEADERBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getLB(){try{return JSON.parse(localStorage.getItem('ahof_lb5')||'[]');}catch(e){return[];}}
function saveLB(lb){try{localStorage.setItem('ahof_lb5',JSON.stringify(lb));}catch(e){}}
function addScore(n,s,st){const lb=getLB();lb.push({n,s,st,d:new Date().toLocaleDateString()});lb.sort((a,b)=>b.s-a.s);saveLB(lb.slice(0,10));}
function renderLB(){
  const lb=getLB(),box=document.getElementById('lbbox');
  if(!lb.length){box.innerHTML='<div class="lb-empty">Wala pa â€” maging unang champion!</div>';return;}
  const mx=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'],rc=['g','s','b'];
  box.innerHTML=lb.slice(0,5).map((e,i)=>`
    <div class="lbrow">
      <div class="lbr ${rc[i]||''}">${mx[i]||i+1}</div>
      <div class="lbn">${e.n||'???'}</div>
      <div class="lbs">${'â­'.repeat(e.st||0)}</div>
      <div class="lbsc">${(e.s||0).toLocaleString()}</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETUP UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildSetup(){
  const grid=document.getElementById('mgrid');grid.innerHTML='';
  members.forEach((m,i)=>{
    const s=document.createElement('div');s.className='mslot';s.onclick=()=>doUpload(i);
    s.innerHTML=`<div class="mav ${m.img?'filled':''}" id="mav${i}">
      ${m.img?`<img src="${m.img}">`:'<span style="color:#1a1a30;font-size:1.8rem">ï¼‹</span>'}
    </div><input class="mname" type="text" value="${m.name}" maxlength="12" placeholder="Pangalan"
      onclick="event.stopPropagation()" oninput="members[${i}].name=this.value">`;
    grid.appendChild(s);
  });
  renderLB();
}
function doUpload(i){
  const inp=document.createElement('input');inp.type='file';inp.accept='image/*';
  inp.onchange=e=>{
    const f=e.target.files[0];if(!f)return;
    const r=new FileReader();
    r.onload=ev=>{
      members[i].img=ev.target.result;
      const av=document.getElementById('mav'+i);
      av.className='mav filled';av.innerHTML=`<img src="${ev.target.result}">`;
    };r.readAsDataURL(f);
  };inp.click();
}
function setDiff(d){
  difficulty=d;
  ['easy','medium','hard'].forEach(x=>document.getElementById('d-'+x).classList.toggle('on',x===d));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(){
  ctx();
  const n=prompt('Ano ang pangalan mo?','Player');
  G.playerName=n||'Player';
  G.level=1;G.xp=0;G.xpNeeded=xpFor(1);
  G.moves=0;G.elapsed=0;G.startTime=Date.now();
  G.revealTime=1.4;G.speedMult=1.0;
  G.totalMatches=0;G.totalBoards=0;G.totalMoves=0;G.totalScore=0;
  G.combo=0;G.maxCombo=0;G.rn=true;intensity=0;tMult=1.0;
  PU={freeze:0,reveal:0,bomb:0,wild:0};
  document.body.className='';
  document.getElementById('setupScreen').classList.add('off');
  const gs=document.getElementById('gameScreen');gs.classList.remove('off');gs.style.display='flex';
  ['winOv','goOv'].forEach(id=>document.getElementById(id).classList.add('off'));
  document.getElementById('lvlov').classList.add('off');
  document.getElementById('freezeov').style.display='none';
  G.boardTime=DIFF[difficulty].time;G.timeLeft=G.boardTime;
  buildBoard();updateHUD();updateTimerUI();updatePUBtns();
  clearInterval(G.tick);G.tick=setInterval(tick,350);
  startMusic();
}

function buildBoard(){
  const pairs=DIFF[difficulty].pairs;
  let pool=members.filter(m=>m.img);
  const EM=['ğŸ˜Š','ğŸ˜','ğŸ¤©','ğŸ˜„','ğŸ¥³','ğŸ˜†','ğŸ™‚','ğŸ˜','ğŸ¤'];
  while(pool.length<pairs)pool.push({name:'AHOF '+(pool.length+1),img:null,emoji:EM[pool.length%9]});
  pool=pool.slice(0,pairs);
  let deck=[];
  pool.forEach((m,i)=>{
    deck.push({id:i,name:m.name,img:m.img,emoji:m.emoji||null,mystery:false});
    deck.push({id:i,name:m.name,img:m.img,emoji:m.emoji||null,mystery:false});
  });
  for(let i=deck.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[deck[i],deck[j]]=[deck[j],deck[i]];}
  // mystery cards starting board 2
  if(G.totalBoards>0){
    const mc=Math.min(2,1+Math.floor(G.totalBoards/2));
    const ids=[...new Set(deck.map(c=>c.id))].sort(()=>Math.random()-.5).slice(0,mc);
    deck.forEach(c=>{if(ids.includes(c.id))c.mystery=true;});
  }
  G.cards=deck;G.flipped=[];G.matched=0;G.totalPairs=pairs;G.timeouts=[];G.locked=false;
  renderGrid();
}

function renderGrid(){
  const grid=document.getElementById('cgrid');grid.innerHTML='';
  const n=G.cards.length,cols=n<=12?4:6;
  grid.style.gridTemplateColumns=`repeat(${cols},1fr)`;
  const aw=Math.min((document.querySelector('.gwrap')||{clientWidth:window.innerWidth}).clientWidth||window.innerWidth,520)-18;
  const cw=Math.floor((aw-(cols-1)*7)/cols),ch=Math.floor(cw*1.36);
  G.cards.forEach((card,idx)=>{
    const el=document.createElement('div');
    el.className='card'+(card.mystery?' mystery':'');
    el.style.cssText=`width:${cw}px;height:${ch}px;`;
    el.dataset.idx=idx;
    const ih=card.img
      ?`<img src="${card.img}" alt="${card.name}">`
      :`<div style="font-size:${Math.floor(ch*.34)}px;flex:1;display:flex;align-items:center;justify-content:center;">${card.emoji||'ğŸµ'}</div>`;
    const mzTag=card.mystery?'<div style="position:absolute;top:3px;right:5px;font-size:.75rem;">âš¡</div>':'';
    el.innerHTML=`<div class="ci">
      <div class="cf"><div class="cpat"></div><div class="clbl">AHOF</div>${mzTag}</div>
      <div class="cb">${ih}<div class="cname">${card.mystery?'âš¡ ':''}${card.name.toUpperCase()}</div></div>
    </div>`;
    el.addEventListener('click',()=>flip(idx));
    grid.appendChild(el);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FLIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function flip(idx){
  if(G.locked||!G.rn)return;
  const el=document.querySelector(`.card[data-idx="${idx}"]`);
  if(!el||el.classList.contains('flipped')||el.classList.contains('matched'))return;
  if(G.flipped.length>=2)return;
  sfxFlip();el.classList.add('flipped');G.flipped.push(idx);
  if(G.flipped.length===2){G.moves++;G.totalMoves++;G.locked=true;updateHUD();setTimeout(checkPair,110);}
}

function checkPair(){
  const [a,b]=G.flipped;
  const ea=document.querySelector(`.card[data-idx="${a}"]`);
  const eb=document.querySelector(`.card[data-idx="${b}"]`);
  if(G.cards[a].id===G.cards[b].id){
    doMatch(a,b,ea,eb);
  } else {
    ea.classList.add('wrong');eb.classList.add('wrong');
    sfxWrong();flash('rgba(232,41,58,.22)');shake();
    G.combo=0;updateComboBadge();
    const t=setTimeout(()=>{
      sfxFlipBack();ea.classList.remove('flipped','wrong');eb.classList.remove('flipped','wrong');
      G.flipped=[];G.locked=false;
    },Math.max(220,G.revealTime*1000));
    G.timeouts.push(t);
  }
}

function doMatch(a,b,ea,eb,silent=false){
  ea.classList.add('matched');eb.classList.add('matched');
  const myst=G.cards[a].mystery||G.cards[b].mystery;
  if(myst){ea.classList.add('mystery-matched');eb.classList.add('mystery-matched');}
  G.matched++;G.totalMatches++;G.flipped=[];G.locked=false;
  G.combo++;if(G.combo>G.maxCombo)G.maxCombo=G.combo;
  if(!silent)sfxMatch();
  flash('rgba(0,232,122,.15)');
  const cm=Math.min(G.combo,6);
  const xpg=Math.floor((20+G.level*8)*cm);
  const sg=Math.floor((100+G.level*20)*cm);
  G.xp+=xpg;G.totalScore+=sg;
  if(G.combo>1)sfxCombo(G.combo);
  popup(G.combo>=4?`ğŸ”¥ ${G.combo}x COMBO! +${xpg}XP`:G.combo>=2?`âœ¨ ${G.combo}x COMBO! +${xpg}XP`:`+${xpg} XP`,
    G.combo>=4?'#ff4466':G.combo>=2?'#f6ca3a':'#00e87a');
  updateComboBadge();
  if(myst)setTimeout(grantPU,300);
  while(G.xp>=G.xpNeeded)doLevelUp();
  updateHUD();confetti(G.combo>=3?18:9);
  if(G.matched===G.totalPairs)setTimeout(boardClear,450);
}

function updateComboBadge(){
  const el=document.getElementById('comboBadge');
  if(G.combo>=2){
    el.classList.remove('off');
    const cs=['','','#f6ca3a','#ff8800','#ff4466','#ff00ff','#00d4ff'];
    const c=cs[Math.min(G.combo,cs.length-1)];
    el.style.color=c;el.style.textShadow=`0 0 18px ${c}`;
    el.textContent=G.combo+'Ã— COMBO!';
  } else el.classList.add('off');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POWER-UPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PU_KEYS=['freeze','reveal','bomb','wild'];
function grantPU(){
  const t=PU_KEYS[Math.floor(Math.random()*PU_KEYS.length)];
  PU[t]++;updatePUBtns();sfxPU(t);
  const lb={freeze:'â„ï¸ FREEZE GET!',reveal:'ğŸ‘ PEEK GET!',bomb:'ğŸ’£ SOLVE GET!',wild:'âš¡ +TIME GET!'};
  puMsg(lb[t],'#ff88ff');flash('rgba(255,136,255,.2)');
}
function updatePUBtns(){
  const map={freeze:'F',reveal:'R',bomb:'B',wild:'W'};
  Object.entries(map).forEach(([k,s])=>{
    const btn=document.getElementById('pu'+s),cnt=document.getElementById('pc'+s);
    if(btn&&cnt){cnt.textContent=PU[k];btn.disabled=PU[k]<=0||!G.rn;}
  });
}
function usePU(t){
  if(PU[t]<=0||!G.rn)return;
  PU[t]--;updatePUBtns();sfxPU(t);flash('rgba(155,64,255,.25)');
  if(t==='freeze'){
    G.frozen=true;document.getElementById('freezeov').style.display='block';
    const m=puMsg('â„ï¸ TIMER FROZEN! 8s','#00d4ff');
    setTimeout(()=>{G.frozen=false;document.getElementById('freezeov').style.display='none';m&&m.remove();},8000);
  } else if(t==='reveal'){
    const um=document.querySelectorAll('.card:not(.matched)');
    um.forEach(el=>el.classList.add('flipped'));G.locked=true;
    puMsg('ğŸ‘ PEEK ALL!','#f6ca3a');
    setTimeout(()=>{
      um.forEach(el=>{if(!el.classList.contains('matched')&&!G.flipped.map(String).includes(el.dataset.idx))el.classList.remove('flipped');});
      G.flipped=[];G.locked=false;
    },1500);
  } else if(t==='bomb'){
    const um=G.cards.map((c,i)=>({...c,i})).filter(c=>!document.querySelector(`.card[data-idx="${c.i}"].matched`));
    const ids=[...new Set(um.map(c=>c.id))];
    if(ids.length){
      const pid=ids[Math.floor(Math.random()*ids.length)];
      const pair=um.filter(c=>c.id===pid);
      if(pair.length>=2){
        const ea=document.querySelector(`.card[data-idx="${pair[0].i}"]`);
        const eb=document.querySelector(`.card[data-idx="${pair[1].i}"]`);
        if(ea&&eb){ea.classList.add('flipped');eb.classList.add('flipped');setTimeout(()=>doMatch(pair[0].i,pair[1].i,ea,eb),400);}
      }
    }
    puMsg('ğŸ’£ BOOM! AUTO-MATCH!','#e8293a');
  } else {
    G.timeLeft=Math.min(G.boardTime,G.timeLeft+12);updateTimerUI();
    puMsg('âš¡ +12 SECONDS!','#f6ca3a');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LEVEL UP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doLevelUp(){
  G.xp-=G.xpNeeded;G.level++;G.xpNeeded=xpFor(G.level);
  sfxLevelUp();confetti(35);flash('rgba(155,64,255,.32)');
  const ov=document.getElementById('lvlov'),tx=document.getElementById('lvltxt');
  tx.textContent='LEVEL '+G.level+'!';
  const cs=['#f6ca3a','#00d4ff','#ff4466','#00e87a','#9b40ff','#ff8800'];
  const c=cs[(G.level-1)%cs.length];tx.style.color=c;tx.style.filter=`drop-shadow(0 0 40px ${c})`;
  ov.classList.remove('off');setTimeout(()=>ov.classList.add('off'),2100);
  if(G.level%2===0)setTimeout(grantPU,800); // bonus PU every 2 levels
  updateHUD();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOARD CLEAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function boardClear(){
  G.totalBoards++;
  const tBonus=Math.floor(G.timeLeft*15),cBonus=G.maxCombo*50;
  const bScore=G.totalScore+tBonus+cBonus;
  G.boardStars=G.timeLeft>G.boardTime*.66?3:G.timeLeft>G.boardTime*.33?2:1;
  sfxWin();confetti(80);flash('rgba(246,202,58,.38)');
  G.rn=false;stopMusic();clearInterval(G.tick);G.timeouts.forEach(t=>clearTimeout(t));
  grantPU(); // bonus PU for clearing board
  addScore(G.playerName,bScore,G.boardStars);renderLB();
  renderStars('winStars',G.boardStars);
  document.getElementById('winBody').innerHTML=
    `Level: <b>${G.level}</b> &nbsp;â€¢&nbsp; Board <b>#${G.totalBoards}</b><br>`+
    `Time Left: <b>${Math.floor(G.timeLeft)}s</b> &nbsp;â€¢&nbsp; Max Combo: <b>${G.maxCombo}Ã—</b><br>`+
    `Score: <b>${bScore.toLocaleString()}</b>`;
  setTimeout(()=>document.getElementById('winOv').classList.remove('off'),700);
}

function nextBoard(){
  document.getElementById('winOv').classList.add('off');
  G.rn=true;G.combo=0;
  G.boardTime=DIFF[difficulty].time;
  G.timeLeft=G.boardTime+Math.min(18,Math.floor(G.timeLeft*.3));
  buildBoard();updateHUD();updateTimerUI();updatePUBtns();
  clearInterval(G.tick);G.tick=setInterval(tick,350);
  startMusic();popup('BOARD '+G.totalBoards+' CLEAR! ğŸ”¥','#f6ca3a');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME OVER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gameOver(){
  G.rn=false;stopMusic();clearInterval(G.tick);G.timeouts.forEach(t=>clearTimeout(t));
  sfxGameOver();flash('rgba(232,41,58,.45)');
  const st=G.totalBoards>=3?3:G.totalBoards>=1?2:G.matched>=Math.floor(G.totalPairs/2)?1:0;
  G.boardStars=st;
  addScore(G.playerName,G.totalScore,st);renderLB();
  renderStars('goStars',st);
  document.getElementById('goBody').innerHTML=
    `Level: <b>${G.level}</b> &nbsp;â€¢&nbsp; Boards: <b>${G.totalBoards}</b><br>`+
    `Matches: <b>${G.totalMatches}</b> &nbsp;â€¢&nbsp; Max Combo: <b>${G.maxCombo}Ã—</b><br>`+
    `Final Score: <b>${G.totalScore.toLocaleString()}</b>`;
  setTimeout(()=>document.getElementById('goOv').classList.remove('off'),400);
}
function restartGame(){document.getElementById('goOv').classList.add('off');startGame();}
function goSetup(){
  G.rn=false;stopMusic();clearInterval(G.tick);
  ['winOv','goOv'].forEach(id=>document.getElementById(id).classList.add('off'));
  const gs=document.getElementById('gameScreen');gs.style.display='none';gs.classList.add('off');
  document.getElementById('setupScreen').classList.remove('off');
  document.body.className='';renderLB();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TICK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastT=0;
function tick(){
  if(!G.rn)return;
  const now=Date.now(),dt=lastT?(now-lastT)/1000:.35;lastT=now;
  G.elapsed+=dt;
  if(!G.frozen){
    G.timeLeft-=dt;
    if(G.timeLeft<=0){G.timeLeft=0;updateTimerUI();gameOver();return;}
    const tInt=Math.floor(G.timeLeft);
    const pInt=Math.floor(G.timeLeft+dt);
    if(tInt<=5&&pInt>tInt)sfxTickDanger();
    else if(tInt<=15&&pInt>tInt)sfxTick();
  }
  updateTimerUI();
  // Speed
  const bb=G.totalBoards*.07;
  G.speedMult=1.0+(G.elapsed/12)*.14+bb;tMult=G.speedMult;
  G.revealTime=Math.max(.17,1.4/G.speedMult);
  const ni=G.speedMult>2.8?2:G.speedMult>1.8?1:0;
  if(ni!==intensity){
    intensity=ni;sfxSpeedUp();
    if(intensity===2){document.body.className='critical';popup('ğŸ”´ CRITICAL SPEED!','#e8293a');}
    else if(intensity===1){document.body.className='intense';popup('âš¡ FASTER!','#f6ca3a');}
    else document.body.className='';
  }
  const pct=Math.min(100,(G.speedMult-1)*100/3);
  document.getElementById('spdBar').style.width=pct+'%';
  document.getElementById('spdLbl').textContent='Ã—'+G.speedMult.toFixed(1);
  updateHUD();
}

function updateTimerUI(){
  const t=Math.max(0,Math.ceil(G.timeLeft));
  const el=document.getElementById('tdisp');
  el.textContent=t;el.className='tdisp'+(t<=5?' danger':t<=15?' warn':'');
  const pct=(G.timeLeft/G.boardTime)*100;
  const bar=document.getElementById('tfill');
  bar.style.width=pct+'%';bar.style.background=t<=5?'var(--red)':t<=15?'var(--gold)':'var(--green)';
}
function updateHUD(){
  document.getElementById('hLv').textContent=G.level;
  document.getElementById('hM').textContent=G.matched+'/'+G.totalPairs;
  document.getElementById('hMv').textContent=G.moves;
  document.getElementById('xpfill').style.width=Math.min(100,(G.xp/G.xpNeeded)*100)+'%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EFFECTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function flash(c){const el=document.getElementById('sflash');el.style.background=c;setTimeout(()=>el.style.background='transparent',130);}
function shake(){const a=document.getElementById('app');a.classList.add('shaking');setTimeout(()=>a.classList.remove('shaking'),350);}
function popup(txt,c='#f6ca3a'){
  document.querySelectorAll('.popup').forEach(e=>e.remove());
  const el=document.createElement('div');el.className='popup';el.style.color=c;el.style.textShadow=`0 0 16px ${c}`;
  el.textContent=txt;document.body.appendChild(el);setTimeout(()=>el.remove(),1400);
}
function puMsg(txt,c='#ff88ff'){
  document.querySelectorAll('.pumsg').forEach(e=>e.remove());
  const el=document.createElement('div');el.className='pumsg';el.style.color=c;el.style.textShadow=`0 0 22px ${c}`;
  el.textContent=txt;document.body.appendChild(el);setTimeout(()=>el.remove(),1600);
  return el;
}
function confetti(n=10){
  const cs=['#f6ca3a','#e8293a','#00d4ff','#00e87a','#ff88aa','#9b40ff','#fff','#ff8800'];
  for(let i=0;i<n;i++){
    setTimeout(()=>{
      const el=document.createElement('div');el.className='cp';
      const sz=3+Math.random()*9;
      el.style.cssText=`width:${sz}px;height:${sz*2}px;background:${cs[~~(Math.random()*cs.length)]};`+
        `left:${Math.random()*100}vw;top:-10px;animation-duration:${1.3+Math.random()*1.8}s;animation-delay:${Math.random()*.3}s;`;
      document.body.appendChild(el);setTimeout(()=>el.remove(),3500);
    },i*22);
  }
}
function renderStars(id,n){
  const el=document.getElementById(id);if(!el)return;
  el.innerHTML='â­â­â­'.split('').map((s,i)=>`<div class="st" style="${i<n?'opacity:1;':''}">â­</div>`).join('');
  setTimeout(()=>el.querySelectorAll('.st').forEach((s,i)=>{if(i<n)setTimeout(()=>s.classList.add('lit'),i*220);}),50);
}

// INIT
buildSetup();
window.addEventListener('resize',()=>{if(G.rn)renderGrid();});
</script>
</body>
</html>
